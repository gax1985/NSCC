




# Malicious Macros





We all know how dangerous it is to click on links in emails



Microsoft has invented *Macros* ; Microsft's original deployment of Windows for the first 10-15 years had a web server boot up automatically without the user's consent. This means that every Windows distribution is *vulnerable* in the name of the user's convenience



>[!warning]
>
>Do **NOT** use Macros in the wild. Please use it responsibly in a lab environment!





##  Macros 



When Macros first came out, they were a convenient way for your document to automatically do something for you. 


>[!Example] 
>
>The Macro could fill in the date, signature, address, etc all in the proper format for the Organization's emails and other communications. Others have used Macros in the past to find things in documents and replace them!



The way they have done this was that they allowed Microsoft Office products to create **Child Processes**. The example of *svchost* is a program in Windows as a shell that executues **DLL** files. 




Services will spawn an *svchost* in an executablke shell and run it for you. 



The *Child Process* has a **PID**, which is its ID
The *Parent Process* has a **PPID**, which is *1* except if it is *malicious*!




When one program running opn the pc executures *another* program,. Microsoft created this capbaility in all of its Office products. We would see it when putting a spreadsheet in the Word document. What happens is a process of Excel is spawned and it has all the capabilties of Excel within the document. 


Since we can get a program to run another program ( macro doing things for us), we can see how it would be used for malicious purposes!

In the design stage, no one imagined that it was a *potential problem*!

In the cybersecurity industry, we like things to be used for an unintended purpose; malicious purposes. 


## First Instances



### Proof of Concpet : 
   
	1995   CONCEPT - First known Macro Virus


### MELISSA
	1999 - 1 million accounts infected - 80 million in damages

### ILOVEYOU 
	2000 - In 10 days, it reached 50 million infections , 8 billion in damages
	After ILOVEYOU, Microsoft disabled macros by default



People run macros all the time!


Macros can create *Child Processes*. There are two problems : 


1. Macros can run by default when you open the document (stopped in 2000 post ILOVEYOU)
2. Being able to spawn ChildProcesses : in 2019 they were able to fix it. It was a feature
   
   
   
   ## Chain of Events 


This ability of programs to communicate with eachother and interact to place an Excel sheet in a Word document, it is known as 


**Component Object Module**



It was hard to get it to work properly, things did not work as intended, and it was plagued with issues. They came up with **Object Imbedding E....** as an answer


After that they came up with **ActiveX**, which most programming languages are able to speak *ActiveX*. It made creating *ChildProcesses* very easy. It was made possible with **Object Oriented Programming**. 

In *Visual Basic*, most people used it to write macros. Instead of recording keystrokes, you can write a macro in Visual Basic to do *ActiveX programming*.  



## Object Oriented Programming 




Comprehension : I sort of get it!


 In terms of the COMM module and how it works, we have a link on the course shell for people who are interested in advanced programming techniques. I should read it and understand it. 


#### Object



We are familiar with data types , which could be a variable holding a character, number string etc 


When defining somethingi n tprogramming , you can give the object individual variables. In object oriented programming they atre called **Attriobutes**


We can also define in the object *Routines*, which gives the objects things it can do!



If we have a database defined as an object oriented object, we should sort the database, so we can call the object with the PRINT method after the sorting is done




##### Example : 


	Object
	Data type
	Int -> number
	Char K
	Object ->
		Attributes
		Methods
	Ron
		Attributes
			Height 5.8
			Weight 188
			Age
			Hair colour= 5.8
		Ron.weight= 188


We can add Ron.say , it can take a string called "hello". If you program it properly, a computer-generated voice could say "Hello"


We might want to have our macro have a SHELL METHOD : 


Ron.say("Hello")'
macro.shellmethod=Macro.addMethod(Insert Malicious Commands here)
macro.shellMethod.Exec("Calc")  ---> Anything that can run in the COMMAND LINE IN WINDOWS! The output of this method does not go to the screen. It goes to STANDARD out *stdout*

Anything running in the program wont appear until you call **READALL** or display the output of *stdout*

when you run the command, the output gets added to *stdout* first, and then the program adds another step to display the output


there is *sterror* (if sterror = 1 , if an error occurs or its value is not NULL)

You would normally have a third level method called **EXECUTE**





# Attack Surface Reduction



First thing in 2000, Microsoft disbales macros by default, but lets the user run them. The user would open the attachment, and it would not run automatically the macro. You would see the link. 


We still had the issue of Office applications *creating Child Processes*. In 2018, Office applications arew not allowed top run *Child Processes*. 


### Policies



Policies are set to prevent actions. 


Applications blocked from creating Child Processes :

Access
Excel
PowerPoint
Visio
Word


Policy locations: 

Microsoft Access 2016\Application Settings\Security\Trust Center
Microsoft Excel 2016\Excel Options\Security\Trust Center
Microsoft PowerPoint 2016\PowerPoint Options\Security\Trust Center
Microsoft Visio 2016\Visio Options\Security\Trust Center
Microsoft Word 2016\Word Options\Security\Trust Center



>[!note]
OUTLOOK NEEDS CHILD PROCESSES FOR IT TO WORK! 


Outlook was intentially left out of the list. Those who cared noticed!

![[Pasted image 20240212140637.png]]




Outlook is an **Object**.. iun the work of *ActiveX controls* each of these applications is an Object. 


Word has Attributes and Methods. When you click on things, you are running Methods. 


When you start Outlook , you are loading up an Object 


What we would want to do is to be in a Word document, create a Macro that has an object defined in the macro that is capable of spawing child processes. 


We would not be able to have a word document to have an excel document imbedded in it, and have it run code. It removed this capability. 

>[!hint]
>
We could be in a word document, and we would add an Outlook object, which is still capable of creating **Child Processes**!



## Issues



They made it that mnacros wont run automatuicallyt when the program is open. It will put" ENABLE CONTENT" banner . We havew to convince the user to CLICK ON IT!



Before the macro can run, when the user opens the word document, you have to convinece the user to click on the button. 

We would switch from Programming to Social Enginerring. 



>[!hint]
>
>How can we convince them ?


#### Social Engineering Methods:


1. First Motivator : **Humans are drawn to *Secret Information***!
   
	Humans are inquistive by nature! If we create the possibilty or thought that someone should click on something to get secret info, they will do it but they would know it is wrong. they keep it a secret! Porn is a malicious vector, as no one will call the IT department to report an issue experienced when accessing porn!


2. Second Motivator : **Tell them it is for *Security Purposes***

	If a producer knows there is a weakness, the producer would need to create the reverse impression of dissatisfaction into a positive idea (our weakness is a feature). 
	Example : Sobeys launched an ad campaign about aged meats, even though the meat was tainted (mistake in feed). We want to tell them it is a necessary action in order to maintain security!


3. Third Motivator : **Tell them it is a *Compatibility Issue***!

	FLASH video player was always being upgraded. There were 100 different versions. People stareted creating flash videos with a message "This player is out of date". The link is malicious! part of Ron's training was to show people that. If something is up with flash, go to the FLASH main website!




#### You have to show them *something*!



You would like it for them to *leave as soon as possible*. At times, if someone shared Onedrive links, it would display a message like "You must request permission from the user", and if the user choses either button, malicious code is launched... etc ...






Example of Social Engineering Document : 



![[Pasted image 20240212141834.png]]


Sent from *HR* .... Confidential! 


This is an enticing document, as people are inquisitive about other people's information. the **SECRET** touch is the first motivator. The user *knows* that they were not supposed to get this email. They wont tell anyone. They could get a message "We are sorry. You need permission".  When they click yes or no, then the code is executed. 


#### Code to Place in a *Macro*

![[Pasted image 20240212142245.png]]



Anything with a tick is a comment 





Sub AutoOpen() ---> launch

'Outlook object


Set objOL = CreateObject("Outlook.Application")
'Create shell under Outlook object'
Set WshShell=objOl.createObject ("wsscript.shell) --- > making the object able to run an embdedded shell 


Set WSHShellExec=WishShell.Exec("whoami")



msgBox (command opens a message box ) (wshshellexec.stdout.readall) ---> shows the contents of the command's output


end sub


(once we have the shell capability, you get the abilities of running anything in the command line)





>[!note]
>
>We SHOULD have a *high-level* Understanding of this topic!
>



This is the only amount of Visual Basic we need to do this assignment




If we wsih to learn more : 


![[Pasted image 20240212143022.png]]Research how it works, its limitarions , its barriers




>[!note]
>
>There is a link on **Brightspace** that could be of interest : 
>
>
>We do not have to put a macro in a particular document. If we run a Word document, there is a .ini file , usually seen when copying directories from one location to another. Everywhere you have documents, you will find .ini files. You can place the macro in the .ini file! Before the "Enable lContent " button, this was the way to do it! Every single Office application woujld run the malicious macro as soon as it is launched! You can use ot to "Enable Content". 



There is one more thing that was added to make the process a lot harder. This is for better understanding : 


	One of the things Microsoft did a few months ago : 
	
	
	The warning on top of emails : This came from outside your network! The way it worked is Office applications having a new ability, they insert a "Web Tag" in the document. In order for Outlook to create a chikld process, you would have to edit the properites of this document to allow it to happen. This is a new creation. You can evade it with : 
	
	1. Part of a Social Engineering campaign : getting them to edit the document themselves 
	   2. We have advanced security features. to vierw it, you have to enable properites. Here is the link on how to do so : .... 




#### Last Assignment : 



>[!danger]
>
>
>The coding challenge is not a challenge because Ron gave us the subroutine code to place in our macro to make it work. We have two challenges : 
>1. Place it a subroutine , put it in the macro, make it work 
>2. Creative componenet : you have to come up with a Social Engerring presentation to covince someone to open the document. It should be something in the docujment to convicne them to click on "Enable Content" for them to see it "This file is encrypted! to decrypt it, please click on it to enable content"
>   
>   
>   We will submit :
>    
>   1. Document
>   2. Screenshot of the Macro running 
>   





