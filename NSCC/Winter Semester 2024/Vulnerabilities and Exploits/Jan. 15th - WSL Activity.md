



We a root DNS system which is *authoritative* (recursive vs authoritative : authoritative servers has a ZONE RECORD of everything ) 


This will send you to : 


TLD-Authoritative
TLD-dotcom
TLD-dotorg  

		If we are lookiong for cnn.com, we get directed to cnn's autoritative DNS' zone , which knows all the subdomains under it which are not visible to any other site

below it 


secondary DNS


primary recursive DNS




below it 


client 


below it 


host




DNS Poisoning : you substitute your fake site weith teh real site 


If you look at rbc.com, they would reach your site




### DNS Poisoning


Taking place ONLY against primary and secondary DNS servers 




2017-2018, everything started to change, due to the need to guard agfainst this vulnerability 


They changed the DNS protocol, and made **DNSSec** the norm 


It made 3 changes to make DNS poisoning either impossible or unlikely ? 

1. Certifications : it guarantees that the response came from the real DNS server
2. Random Query ID : increment sequentially. If you guess a 100 times, you could get it. Now, the Query ID is *randomized*.  
3. Random Source/Destination Port : always the same port, unlike most things we see . If we have to send an answer t0o a client, you would guess the source port (default port for DNS is **53**). Number of guesses is tens of thousands. 
4
They allowed the randomization of the source port, so a malicious actor would not know which is the source port to send it to! 
on your pc, you get a randomized destination port. 

There are some destination ports that ascribe to a service. 


DNS Poisoning attacks do not work on new DNS servers installed post 2018. If you have an older server pre 2018, it is not a likely occassion for someone to get the need to update the DNS server. This makes them vulnerable. 



## Zone records : 



Start Authority : 


It has the **Serial Number** ... Why ? 


Authoritative site for CNN.com is not the only DNS server at that location. They will have multiple secondary DNS servers in place that has a copy of all the zone records from the main one. It has to keep the copy up to date. The way it keeps track is **Start of Authority Record** has a serial number, which will get copied. The serial number is supposed to be incremented *manually*. If they are using a third-party DNS management application it could do it automatically. The *Zone Records* tells you how long you would wait between checks. It has a timed measure for checking the serial number. The Zone Record contains information on any subnets, IP addresses of all the servers (mail, VOIP, services available at the website/domain not broadcasted to the public ( like an FTP server). All this information is stored in the zone records. You may have email addresses, code, etc. Google Analytics is available from google to gather data on your website, like how many people visited, detailed information on them etc. Google will send you a verification code, which you would put in your website. The google analytics then provides you with information. Other companies have a verification code that they send you. The information has to be kept track of. There is a lot of information hackers could get. 


Contained in the zone records is information on the OSes you are running, what make of computer it is. This is a detailed map of the organization's infrastructure. You could Social Engineer your way into the DNS manager. 


The authoritative DNS server has to have zone files, and the zone files has this information. If we set up an authoritative DNS server, which is far more complex , 



Ron is looking for a capstone/work term project, he would set up a vulnerable DNS server. It is tough to do. It was the second assignment for the Attack Vectors course since 2017. In 2018 , the strarted doing DNS updates, so the components became difficult to find.  The system within Linux that allows you to set up a DNS service called **BIND**, which is the application that was vulnerable . Inside **BIND**, there is a configuration file called name-d.com. Ron decided not to do this assignment anymore. A dedicated project on this topic would be interesting. 

>[!hint]
>EVERY DNS SERVER PRIOR To 2018 is vulnerable to this!





If we set up a DNS server, we would learn a lot about DNS servers. 


Why does this contain this information ? It has to be there for the DNS system to work. Every few seconds, it copies the zone records. When folks were setting this up, they did not put security checks because they did not think of the possibility of malicious intentions. All this has to be publicly accessible in order for this to work. We could go on our computer, go to an Authoritative DNS server, and pretend to be a Secondary DNS server. 




It was a Recursive Server on Firewalls class. 




# WSL Activity



## Non Authoritative Response : 


Coming from the cache



Startup authority record : contains administrative information like Time to Live


Contains items like the MNAME( primary name server for this domain). NS = Name Server
RNAME : Email address pf the domain administrator
Serial : Serial number
REFERESH : refresh timing, how odten does it check ? 



A Record : contains IP addresses
MX Record : Mail Exchange server (email)
POINTER : Redirect the requertst to another place, or return a response. 
Canonical name is related

The A Record has the IP address 

AAAA has IPV6 address



NS Record : Auithrotive name server can reslve sub domains, TLD NS servers do NOT. 



Pointer record does trhe  opposive of A record . It maps IP addresses to domnain names. A lot of people when setting up the email will install reverse DNS lookups so spam can be rejected. 


CNAME converts one name to another (like an alias)


Service record : lists all the services available on this site. This is not published on the website, You can find FTP servers for example

Text records: theyt do two purposes : senter profile fframework record :" prevents spoofing by saying which email servers can send emails on your domain 




COnfig file : 


	zone "ron.com IN
	
	{tupe matser : 
	file "rom . com . zone e}
	"


,,,,





AZone records : 


serial number
refresh
timing , 
SOA dns1.ron.com hostmaster.ron.com
mail exchange server


here the DNS server has anb IP server atrtached. His machine has an IP address attached. The mail server refers to a canonical name. 


Since it is his local macvhine, the dns address is the same


CANONICAL name is an alias. We go to cnn.com, the canonical name might say " you got to do one more strep at this location." you can have multiple aliases.





Now , let us do this :





## WSL Activity 




The command : 


		dig NS zonetransfer.me







The first thing we have to know : 


1. Where the **AAuthorittyative DNS Server** for that zone. The information is *public*. You have to inqurie with the domain "where is your DNS server?". So, we will use the command *dig*, which stands for **Domain Information Getter**. We have a pentester in the UK named "RObiun hood", and he has been teaching this for years. There is NOTHING to attack. He set up this domain called "ZONETRANSFERME" to see this in action. We would ask zonetransfer.me where its name server is (**NS**)



Result : 


		Resolving deltas: 100% (55977/55977), done.
		hashimoto@LEGION:~/.local/share$ dig NS zonetransfer.me

		; <<>> DiG 9.18.18-0ubuntu0.22.04.1-Ubuntu <<>> NS zonetransfer.me
		;; global options: +cmd
		;; Got answer:
		;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 64570
		;; flags: qr rd ad; QUERY: 1, ANSWER: 3, AUTHORITY: 0, ADDITIONAL: 0
		;; WARNING: recursion requested but not available
		
		;; QUESTION SECTION:
		;zonetransfer.me.               IN      NS
	
			;; ANSWER SECTION:
		zonetransfer.me.        0       IN      NS     (first one did not work) nsztm1.digi.ninja.
		zonetransfer.me.        0       IN      NS      nsztm2.digi.ninja.
			nsztm1.digi.ninja.      0       IN      A       81.4.108.41
	
	;; Query time: 9 msec
	;; SERVER: 172.24.112.1#53(172.24.112.1) (UDP)
	;; WHEN: Mon Jan 15 14:28:49 AST 2024
	;; MSG SIZE  rcvd: 143



:Next, we will see if it would do the zone transfer to us! Here is the command that would make it work : 



		dig axf @nsztm2.digi.ninja zonetransfer.me


x f r = shorthand for transfer 

a = all records 


"Transfer all of your zone records"


If the secondary wanted to transfer, we would do iaxfr





Result : 



		dig axfr @nsztm2.digi.ninja zonetransfer.me

; <<>> DiG 9.18.18-0ubuntu0.22.04.1-Ubuntu <<>> axfr @nsztm2.digi.ninja zonetransfer.me
; (1 server found)
;; global options: +cmd
zonetransfer.me.        7200    IN      SOA     nsztm1.digi.ninja. robin.digi.ninja. 2019100801 172800 900 1209600 3600
zonetransfer.me.        300     IN      HINFO   "Casio fx-700G" "Windows XP"
zonetransfer.me.        301     IN      TXT     "google-site-verification=tyP28J7JAUHA9fw2sHXMgcCC0I6XBmmoVi04VlMewxA"
zonetransfer.me.        7200    IN      MX      0 ASPMX.L.GOOGLE.COM.
zonetransfer.me.        7200    IN      MX      10 ALT1.ASPMX.L.GOOGLE.COM.
zonetransfer.me.        7200    IN      MX      10 ALT2.ASPMX.L.GOOGLE.COM.
zonetransfer.me.        7200    IN      MX      20 ASPMX2.GOOGLEMAIL.COM.
zonetransfer.me.        7200    IN      MX      20 ASPMX3.GOOGLEMAIL.COM.
zonetransfer.me.        7200    IN      MX      20 ASPMX4.GOOGLEMAIL.COM.
zonetransfer.me.        7200    IN      MX      20 ASPMX5.GOOGLEMAIL.COM.
zonetransfer.me.        7200    IN      A       5.196.105.14
zonetransfer.me.        7200    IN      NS      nsztm1.digi.ninja.
zonetransfer.me.        7200    IN      NS      nsztm2.digi.ninja.
_acme-challenge.zonetransfer.me. 301 IN TXT     "2acOp15rSxBpyF6L7TqnAoW8aI0vqMU5kpXQW7q4egc"
_acme-challenge.zonetransfer.me. 301 IN TXT     "6Oa05hbUJ9xSsvYy7pApQvwCUSSGgxvrbdizjePEsZI"
_sip._tcp.zonetransfer.me. 14000 IN     SRV     0 0 5060 www.zonetransfer.me.
14.105.196.5.IN-ADDR.ARPA.zonetransfer.me. 7200 IN PTR www.zonetransfer.me.
asfdbauthdns.zonetransfer.me. 7900 IN   AFSDB   1 asfdbbox.zonetransfer.me.
asfdbbox.zonetransfer.me. 7200  IN      A       127.0.0.1
asfdbvolume.zonetransfer.me. 7800 IN    AFSDB   1 asfdbbox.zonetransfer.me.
canberra-office.zonetransfer.me. 7200 IN A      202.14.81.230
cmdexec.zonetransfer.me. 300    IN      TXT     "; ls"
contact.zonetransfer.me. 2592000 IN     TXT     "Remember to call or email Pippa on +44 123 4567890 or pippa@zonetransfer.me when making DNS changes"
dc-office.zonetransfer.me. 7200 IN      A       143.228.181.132
deadbeef.zonetransfer.me. 7201  IN      AAAA    dead:beaf::
dr.zonetransfer.me.     300     IN      LOC     53 20 56.558 N 1 38 33.526 W 0.00m 1m 10000m 10m
DZC.zonetransfer.me.    7200    IN      TXT     "AbCdEfG"
email.zonetransfer.me.  2222    IN      NAPTR   1 1 "P" "E2U+email" "" email.zonetransfer.me.zonetransfer.me.
email.zonetransfer.me.  7200    IN      A       74.125.206.26
Hello.zonetransfer.me.  7200    IN      TXT     "Hi to Josh and all his class"
home.zonetransfer.me.   7200    IN      A       127.0.0.1
Info.zonetransfer.me.   7200    IN      TXT     "ZoneTransfer.me service provided by Robin Wood - robin@digi.ninja. See http://digi.ninja/projects/zonetransferme.php for more information."
internal.zonetransfer.me. 300   IN      NS      intns1.zonetransfer.me.
internal.zonetransfer.me. 300   IN      NS      intns2.zonetransfer.me.
intns1.zonetransfer.me. 300     IN      A       81.4.108.41
intns2.zonetransfer.me. 300     IN      A       52.91.28.78
office.zonetransfer.me. 7200    IN      A       4.23.39.254
ipv6actnow.org.zonetransfer.me. 7200 IN AAAA    2001:67c:2e8:11::c100:1332
owa.zonetransfer.me.    7200    IN      A       207.46.197.32
robinwood.zonetransfer.me. 302  IN      TXT     "Robin Wood"
rp.zonetransfer.me.     321     IN      RP      robin.zonetransfer.me. robinwood.zonetransfer.me.
sip.zonetransfer.me.    3333    IN      NAPTR   2 3 "P" "E2U+sip" "!^.*$!sip:customer-service@zonetransfer.me!" .
sqli.zonetransfer.me.   300     IN      TXT     "' or 1=1 --"
sshock.zonetransfer.me. 7200    IN      TXT     "() { :]}; echo ShellShocked"
staging.zonetransfer.me. 7200   IN      CNAME   www.sydneyoperahouse.com.
alltcpportsopen.firewall.test.zonetransfer.me. 301 IN A 127.0.0.1
testing.zonetransfer.me. 301    IN      CNAME   www.zonetransfer.me.
vpn.zonetransfer.me.    4000    IN      A       174.36.59.154
www.zonetransfer.me.    7200    IN      A       5.196.105.14
xss.zonetransfer.me.    300     IN      TXT     "'><script>alert('Boo')</script>"
zonetransfer.me.        7200    IN      SOA     nsztm1.digi.ninja. robin.digi.ninja. 2019100801 172800 900 1209600 3600
;; Query time: 30 msec
;; SERVER: 34.225.33.2#53(nsztm2.digi.ninja) (TCP)
;; WHEN: Mon Jan 15 14:32:00 AST 2024
;; XFR size: 51 records (messages 1, bytes 2141)



Recall, 








Google Analytics : 


If you are trhe real owner, we will send a verification code. if you entrer it quickly, then its a go ahead. if someone stored the verification code in a text file, we will find it!


MX records : ASPMX.google .. .... What does this tell us? theyt use gmail. Chances are they are not doing spam filtering . 


A record for zoneteansfer me



acme_challenge : they need to have a verfication code in TXT. 



Service Record (SIP = VOIP)


A Record 


LOC Record : Location of the office


Location for the Canberra office 

We have name/phone number of the DNS admin



If we want to go to zonetransfer.me in a browser : 




[[ZoneTransfer.me - DigiNinja](https://digi.ninja/projects/zonetransferme.php)]]





You can try the Zone Transfer command once you have the DNS server. You can use the *dig* comand to transfer the zone files from any DNS server, except in North Dakota ( it is illegal to do a Zone Transfer).





## Directory Services' Vulnerabilties Assignment


They apply to DNS ARP, LDAP, etc. .. it is not because something is broken or some mistake or some fancy exploit, we are not doing anything except use the protocol in the way it is meant to be used. The way the protocol works create the vulnerability. When getting the assignment, where we do Directory Service VUlnerabilties, we do it in Windows not Linux .


The command to do this in Windows is : 


	nslookup 


Which requires a bit more configruration. Ron's suggestion : 


We Mustr be able to locate the authorittative dns server at the site, figure ouyt the zone transfer, and you replaicate it with *NSLOOKUP*. 


If you are an organization like NSCC< you get a big security team. They would make sure that they have the latest DNS softwarte, and disallowed Zone TRransfer. named.conf has an option to block transfers ( you have to do this manually. named.conf and change the setting so transfers are disallowed unless you are a particular ip in the domain , or their secondary. Most people do not know about it). How can you further secure it ? You would use certificates , used to verify the entity making the request. You have one syustem who can legitamely issue a reqiest there. The identity should be established with certificates. An Israekli company did this on braking systems on cars. Because there is no security layer inside the car's network. They built an addon to the car where the engine control module has a certificate, and the yhave certificate authentication to insure that the command came from the car. 


In the wargame, one army had a truck full of equipment, and all of the sudden, the truck's engine shut off. the other team had someone issue a command to the truck to deflate the tire, and that truck has a condition if the tires have no air, the engine shuts down. We will be faced with the situation that works like this :" this system can issue a command without checks. The solution is to introduce the certificate model. 



Figurew out : 

# Zone Transfers using NSLOOKUP



Have a look at **zonetransfer.me** site, which has a wealth of valuyable infoprmation 