



We talked about **Active Directory Vulnerabilities**, where you use something that you *know* to find something that *we do not know*




We looked at **ARP**, *Routing Tables and how they find machines on your network*. 




Assignment 2 puts more weight in **effort and care**!  We are faced with a task that should be manually constructed and broken down *piece by piece*. You are learning how to masqueade IPs and how to do a **MiTM** attack 





# The *seth* Command  



It is designed to get in the middle of an *ARP Session* 


We are familiar with the **Remote Desktop Protocol** on port *3389*



**RDP** is used when you would like to remotely manage the machine. In order to do so : 

1. ARP has to be enabled, and you enable it with a **Username/Password**



The highest level of *Authentication* to log in is **Network-Level AUthentication**, which means : Normally when you log in the computer, you type in your credentials. When you set up/change the passwortd, the password is not stored in LSAT (Windows) or memory. The Hash of the password is stored in memory



Windows hashes what you typed, hashes the password and compares them



You can change to a higher level of encrtyption, add a **Salt**, use SSL/TLS' Different Levels, but essentially, you are only checking w ith your machine. With RDP, you are sending/typing a password that is being sent off to that machine, and the machine can use different levels of encryption for checking the password. You can choose a stronger encryption method to do the same checking, or you get into **Network - Level Authentication **, which means that there is a Domain that will check the hash of the password you typed, check it with the hash of the password that is stored, and may add in a stronger encryption algorithm. There are multiple levels of authentication that you can do (Kerberos) 



Three Levels : One against the DC/ It could be using a third party system which brings a stronger method of authentucation | RDP authentication ( more advanced ) | baselevel authentication for RDP



When a client attaches to the RDP asever, the client and server agree on the highest level of authentication that is present in both systems. It will try the hardest level. 



There is a checkbox "enable Network level Authentication ". If it is *not* checked, the server cannot do network-level authentication. 


If you remote in to your home machine,m you would not check that box. It could be the admin did not set up Network level authentication. 


When the client wants to use network level authentication, the server will say that it cannot do that. 


The client will say " Can we do the advanced level of RDP authentication? " if the server replies " I will go down to the native level of authentication for RDP" which is easier to deal with from an attacker's end. 


In an attack, you are trying to get both parties **to agree on the lowest level of authentication**. This is called a *Downgrade Attack*. The exploit that Ron is showing us is MiTM wotj yje attacker pretending to be the server, and to be incapable of the higher levels of authentication. Whayever the client sends to them, they will pass off to the real server. MiTM will convince the client that the attacker is the server to get to. When you get those who are seeking the server to come to you instead with ": Poisoning ARP Table" , substituting mac address for his ,. changing the ROOT Table. ....


We will do ARP poisoning , the fake server will say " I can not do so. Let us go to the lowest level of authentication.".





If we are going to a publicallyfacing server, we would see at times " Cannot verifty the authentication of the server"

This is caused by *Self-Signed Certificates*. If you set up a server, and you want people to come to it, you can go to RSA and purchase a certificate (encrypted key's hash to be used in authentication for SSL/TLS). When establishing a Google Account, it downloads a certificate that uses encryption to authenticate you. SSL --> Secure Socket Layer , TLS --> Transport Layer Security (it is a better version of SSL_) 




Ron mentioned that he creates his own certificates, and when the customers come to his server they would get the usual self sibn ed certificate. Ron warns them, and network admins understood. A lot have internal servers for whatever application the user is running, and they would use self-signed certificates (it is all internal )


People get used to using Self Signed Certificates, that is how we will do this attack. 


We should be cautious of the warning message when browsing a website online, as it could be the site you are visiting is not the genuine website. 



This hack will use the *Self Signed Certificate*. It will do a *Downgrade Attack* , and the fake server will mention it is not capable of higher-levels of authentication. 



# The Attack 



The attacker goes in and *poisons the ARP Table with his MAC Address* first! 



>[!note]
>
>Watch Adrian Vollmer's "Attacking RDP with Seth" : 
>
>https://www.youtube.com/watch?v=wdPkY7gykf4&pp=ygUcYWRyaWFuIHZvbGxtZXIgYXR0YWNraW5nIFJEUA%3D%3D
>




With the **"View Certificates"** option, he tried to log in to the domain controller to see if they are using Properly Signed Certificates ( Self-Signed). Previously, *caine* was used to crack the password and ARP poisoning. The tool is for *Windows*, close-sourced, it can attack only the lowest levels of encryption. The attacker wrote **SETH**, and it is intended to be used in workshops to bring awareness to the risks behind *Self-Signed Certificates*. 


RDP is using something similar to TLS. In the beginning, it speaks in clear text, and then switches to SSL. (**The Initial Commuinication is not encrypted. Until your two sides agree on the level of encryption, it is not encrtpted until tyhe agtreement is made)


You would need the **SSL Key/Ecnrypted Hash/Public key for teh server** to break the private communication. 



It would be a good idea to have every implementation to have its own *certificate*



RDP's specifications are publically available. Typically, in Wireshark, we would see every TCP ppacket, the first packet is the beginning of teh TCP Handshake. We can see that RDP security is available at the client's end. The client proporses the highest level of security ( not network level, just the highest available). The server checks if the user is authorized before the authentication happens. 


The server answers with the agreed upon highest level of enccyrption available on both ends.  


If we want to attack RDP, we need to know about the *security Protocol*  of RDP :  Strandard / Plain / NTLMV2  

### Standard 


Initial communication/Sercver sends its public kkey to the client / future communication : server sends publlic key to client ---> use this to encrypt communicatyion, 


client has to verifty that it is a valid RDP ssl certificate for windows server


It encrypts the next level of communication. 


We want to see that level of traffic. Idealy, we would want to see the password that the person types in, which will be on baselevel SSL encryption. 


two levels of encryption : WE USE RDP NATIVE  SSL COMMUNCAITION TO ENCRTPT THE FIRST portion + includes the user logging in | commnunication is done using base SSL//RDP Encryption --> we want to crack that.




**rc4** is used to encrypt the rest of the communication. 



Microsoft's private key is pyblic. Windows uses the same signing key for every instance of RDP. People quickly figured out that tghe *signing key* is always the same. Microsoft instead of changing this approach, they published the key themselves. 



CAINE is exploiting this particular key





## Enhanced RDP Security ( Next level up, not native ) 



Security is shifted to the next level up. It should have the root cetrigficate stored. 


If the domain controller does not have the rfole "**Atcitve Directoryut Certificate Serveices"



UIf you are setting up a DC< and you do not want to use self signed cetificates, there is a role "Actrice Directory Certificate services" should be enabled, which enables the machine to store the keys. iIf not using it, self signed certtifcates are used by default. 





NTLM Response : Server sends "Server Random" to clinet } client computes hash value of hased password and other things such as client random, server name, tunestamp, etc....  ( if you have NTLM response, you can try guessing the answer)


Kerberos has several vulnerabiltities such as Golden Ticket, Kerberoast, but none are relavent. 



Construction of the attack !


1. ARP Cache poisoning  -- starting point  (root table modification on our Assignment)


Step 1 : client wants kerberos : what shall we do ? let us block port 88 TCP traffic ( block kerberos authentication)



Step 2 : rediurect traffic through Python proxy 



Step 3 : We prevent NTLM authewntication ( a bit more difficult, we control the traffic between the client and the RDP host, but not with RDP Host and domain controller). What does hapopen if the RDP host cannot reach teh domain controller? There is an error message which wwe will replace with " :Make the client believe that the host could not reach the Domain Controller . " The client will now use enhanced RDP security . 


Step 4: The victim will see a certificate warning. The attacker watches what the victrim is typing with the RDP connection. 







Demonstration : a client running Windows, and another machiene running Kali 




The command : 


	./seth.sh eth1 192.168.57.1   
	
	
VIctom is connecting : 


The victim/client : I canot verify the certificate by the RDP host (attacker, who went into the certificate from the sercer, put in his own encryption keys, and then he could see the NTLM response. 



The attack is partially based on people using a bad password. Buried within the encrypted response is the password. We can run it through rainbow tables, to get this password The more difficult the password, the harder it is to break it. 





Note : the attacker can see the keys being typed, as the key presses are passed on the server. Since he is in the middle, he is logged in to the sever using the victim's credentials, which he uses to executure commands on the server. 


(attacker managed to get everyone to use the lowest level of encryption possible) . Since he did that, he could do *remote code execution*, he can *decrypt the password* , and *he can see the key strokes* . 



What happens if the client **DOES have Network Level Authentication**? 



The attacker is enabling mandatory NLA ( network level authentication ) on the RDP server  for demonstration: 



The attacker would keep talking to the client all the way unto the authentication. The client's connection is lost, but the connection is alive for the attacker. We could reestablish the connection to the host with NTLM. 





"What can be done about it ? "



NLA protects the server from *Zero day , RDP , Windows Logon screen*, Domain admins should lock tooks to the domain controller. If you use NLA< the credentials are kept on the cliernt on the memory. SSL is already secure, but we would not be able to trust every certificate that we encounter. We should choos " RDP connection cannot be established until the server/client's identity is verified.". Roll out properly signed certificates,.



>[!todo]
>
>
>Do not use Self-Signed Certificates, and try to use **SETH**
>


The warning from the server meant that we could not verify this certificate. The client could only accept SSL level 1st level of encryption before deciding which encryption to use. 




# RDP Protocol 



RDP Protocol Sequence : 


There is an entire discussion before you go to the RDP encryption for the conversation





## Major Vulnerability with RDP 



In the olden days, there were Terminals connected tyo a central computer, and everyone is using it. Now we are in a world with computers sitting on your desk. RDP was made to mimick the sense of using a shared computer with everyone. There were 32 static channel (max) machiens all RDPing itno the server ( 32 machines connecting to RDP max)

Instead of the Static Fixed Channels, they made a DYnamically shared channel . They tagged the identity of each workdtastion andf sends it through the trunk. 


As the user was set up, the computer will automatically assign channel/channel number. 31 or 32 was used as a management channel for maintiaining RDP, and not for the usewr.It had a particular name associated with it. You **CAN SPOOF** your channel name. If you changed the channel name to the name of the management channel. All you have done on the client's side was to rename the channel to the nbame of the management channel, RDP crashes, but leaves you logged in into the victim's machine. . 


RDP has been combed in many different ways. RDP was not left behind by Microsoft. 



>[!note]
>
>
>Ron was unhappy with the level of knowledge going from 1st years to 2nd year. Ron would like us to feel a bit uncomfortable, with a lack of misunderstanding. if offensive security will be our thing (usually people who like math), if you are sitting in the room, and you would like to learn more about it, and you get to try the tool like SETH, or digging into the protocols, so this way, we would have a generla understanding of what is happening. If you wantt to go in offensive security, you can proceed. If you decide to go into Blue Teaming, you will lock down a lot of things, as you would be focused on stopping attacks and attackers from happening. 



Attack surface Reduction rules produced by Microsoft ( it provides instructions to keep things from happening). Bshowing us the offensive attacks, we know it is possible. We can look at someone's server and discover if they are forcinbf NLAs, you know which holes to plug to keep leakes out. You would need to know that the exploit exists



Ron does not expect us at the end of the course to do these attacks from memory. Be aware of it, and we will discuss how we can mitigate these attacks. We will discuss the other things. We will do so for every protocol and for every process. 



>[!danger]
>
>
>
>ASSIGNMENT DUE DATE IN a week and a half FROM JAN 31st! 


>[!note]
>
>Next class : **Kerberos!** 
>



















