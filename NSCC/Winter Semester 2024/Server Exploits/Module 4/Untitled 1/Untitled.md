

## **The Writable /etc/passwd**

We’ve seen how to get a reverse shell, and gain access to our Ubuntu machine through DVWA. However, we only have access as www-data - the account that controls Apache. www-data does not have many permissions, so as an attacker we don’t really own the machine. We need to get access to the root user. However, if we look at our Ubuntu machine, our user is the only member of the sudo group. That means www-data can’t run the sudo command and execute commands as root. There are some common misconfigurations we can look at exploiting to get root.

## /etc/passwd

/etc/passwd holds all information about users on the system. In older versions of Linux, this also held users’ password hashes. Now those hashes are in /etc/shadow, which only the root user can read. However, for the sake of backwards compatibility, /etc/passwd can still have someone’s password hash if we can write to it. By default /etc/passwd is only writable by the root user but on rare occasions (I’ve only seen this once in my whole career), it can be written to by other accounts. We can exploit this misconfiguration to create a new root user.

#### SSH Configurations

>[!note]
>
>**The */etc/ssh/sshd_config* File**
>
>1. We will eventually be using SSH to login as our new root user, so head over to /etc/ssh/sshd_config and change **PasswordAuthentication** to *yes*.
>2. We next have to allow root users to SSH into our Ubuntu machine. This is done by setting **PermitRootLogin** to *yes*. You can save the config file now. Don’t forget to restart the ssh service when you’re done :
>   
	sudo systemctl restart ssh


#### ... Continued ...

Next we want to give /etc/passwd terrible permissions with *chmod*. Chmod uses numbers to assign permissions, and it’s a case of adding the numbers you would like to give.

Run the following command to give *read and write* (we don’t really need execute) to everyone on the system. You can use ls -la to confirm the changes have been made.


	sudo chmod 666 /etc/passwd

## Exploitation

Now get a reverse shell on your kali machine. You can use any exploitation method on DVWA. Verify you are www-data with the whoami command.

Exploitation

We can now write to /etc/passwd. We want to create a new root user (I call mine root2) and give it a password by writing it in /etc/passwd. However, /etc/passwd expects a password hash, not a plaintext password. So we will pick a password (I pick “evil”) and hash it first. We can use *openssl* to hash a password in SHA 265 crypt, which is a standard account hash for Linux.


>[!hint]
>
> To hash the chosen password ("evil") using SHA-256 :  
> 
	openssl passwd -5 evil
>
>The resulting hash would be : 
>
>	$5$oIxOFNy6FSNuymMN$uoLnr4lNHxdV2rv/zyYXWdTkEYPjd5MPLOuFNy35Ee4

#### **Explanation:**

- The `openssl passwd -5` command generates a SHA-256 crypt hash for the specified password ("evil"). This hash will be used to securely set the password for the new root user in the `/etc/passwd` file.
-
>[!challenge]
Try to generate a different type of hash for the password "evil" using the `openssl passwd` command.

>[!todo]
>
>Implement strong password policies and encryption mechanisms to protect user credentials. Regularly rotate passwords and use robust hashing algorithms to securely store password hashes.

Exploitation

Now we can write to /etc/passwd from our reverse shell on Kali as www-data and write to it. We want to write the following line to add a new root user called root 2. If you use nano it’s messy on a reverse bash shell, so you can use the following command to append the line to the end of/etc/passwd. Make sure you use “>>” rather than “>” or you’ll overwrite the entire /etc/passwd file (might be good to snapshot your Ubuntu before doing this just in case).

