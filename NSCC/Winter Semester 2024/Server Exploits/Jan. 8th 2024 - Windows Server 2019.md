




We will be installing **Windows Server 2019** from *Azure for Education*




We will be doing a local account. 


We will be using the **RDP Remote Desktop Protocol** with port *3389*



We will be enabling a *vulnerable* **RDP Service**



Remote desktop will run automatically on boot. 



Windows would have a software-based server running automatically. 




Windows Defender : Allow connections from **Certain IP addresses only**.




We will write a script to enumerate SSL cipher. 


It uses TLS as a protocol , 1.0. 


For ciphers , 3DES is a *weak* cipher

TLS 1.0 is also a *weak* cipher



## Bruteforcing RDP



We will use **THC-Hydra**


We will be doing a *Dictionary Attack*


We will create two dictionaries for usernames and passwords. 



hyra -L (list of usernames) user.txt -P pass.txt http://192.168.1.30 -t (threads) 1 

nmap -Pn (dont give up if PING does not work)






# Protecting RDP




we enable a lockout policy to lock out after 3 times


The **Bruteforce** attack is unlikely to succeed in the second attempt


The *Lockout Period* being *10 minutes* is excellent. We can do 30 minutes if we wish 




## Registry Keys



We can disable TLS 1..0 with **Registry Keyss**


RIght click PROTOCOLS, TLS 1.0, Select the server key , click New--- DWORD value

Make it **enabled**, with 0 ( flase )


Reboot , and TLS 1.0 is gone!






# Bruteforcing RDP : The Steps 





1. Install Windows Server 2019 Standard

	● Setup Windows Server 2019  
	○ 4 cores, 8GB RAM, 60GB storage  
	○ Install the Desktop Experience


2. After the installation, boot up **Kali Linux**


3. Launch your favorite terminal, and use the *nmap* command : 

			nmap -p 3389 (RDP's Port) 192.168.142.0/24 (If we do not know the IP Address) -v (for Verbose, which shows us more behind-the-scenes actions that the nmap command does)


		The Outcome : 


			Note: Host seems down. If it is really up, but blocking our ping probes, try -Pn



4. So, as we are the persistant folks that we are, we add the following *-Pn* option, which yields the following result : 

			Host Discovery Disabled (-Pn). Scanning is slower ...
			Completed Connect Scan : 


			3389/tcp filtered ms-wbt-server 192.168.142.254 



5. Let us enable **Windows Remote Desktop** : 

			1. Open the Settings app on Windows Server 2019
			2. Search for "Remote Desktop"
			3. CLick on "Enable Remote Desktop"
			4. Configure the Windows Firewall to allow Incoming Connections on Port 3389


6. Let us try **nmap** again : 



			nmap -p 3389 192.168.142.254  -v 

			(Same Result as Before)

			namp -p 3389 192.168.142.254 -Pn : 


			Result : 

			Host is Up! 
			3389/tcp Filtered ms-wbt-server 



7. Let us do a *Script Scan* with **nmap** to find out if Windows Server 2019 has a vulnerable version of TLS : 



			nmap -p 3389 --script ssl-enum-ciphers 192.168.142.254



			same result as before, whenever we issued the command without the -Pn option, it does not work.



			Now, with the -Pn option : 


				...Lots of Information about the SSL/TLS version and the Ciphers used. 


> !hint
>
>Look up the **SWEET32** 3DES Attack!



8. Now, if we use a different Script scan with **NMAP** : 


			nmap -p 3389 192.168.208.136 -Pn --script rdp-ntlm-info -v


			... We get lots of useful information about the RDP server running right now!


9. Now, time for Brute-Forcing Preparations. We need to create a *dictionary* for usernames, and a second *dictionary* for passwords!


			nano usernames.txt 
			
			
			
			or ... 
			
			
			echo "username" >> usernames.txt
			echo "user" >> username.txt


> [!important] 
> **Question :** How can we fix RDP's security situation? 
> **Answer :**  Establish a *Lockout Policy (where a number of failed attempts will block any further attempts for a time period)*, establish *a more robust Encryption Algorithm*, *Disable Copy and Paste*, and set up a policy which *Disables Reboots*.
> 


10.  Now , let us launch the **THC-Hydra** , and conduct the RDP attack : 


			hydra -L user.txt -P pass.txt rdp://192.168.208.136 -V (verbose) -t (determines the number of tasks to run in parallel) 1



			... It ended up being successful, and retrieved "username" as the username, and "password" as a password!


11. Since now we have determined the weakness in this Windows Server 2019 installation, let us fix it! Search for "**Local Security Policy**" on Windows Server 2019...


			1. The first item on the list to fix is "Account Lockout Policy"
			
				Let us set a number of tries for the login to "3" if you like, or 2 as our instructor suggests (since it is not as expected as 3 tries). It automatically suggested changing the Lockout Duration to 30 Minutes, and to reset the Account Lockout counter after 30 minutes. 
			
			2. We can set "Reset Account Lockout Counter After" to 10 minutes.
			
			3. Let us set "Account Lockout Duration" to 10 minutes or 30 minutes if you wish.
				


12. Now, let us try **Hydra** again , and see if those changes helped matters :


			hydra -L username.txt -P password.txt -V (verbose) -t 1 rdp://192.168.208.136


			 ( In my case, it seems that it had no effect...)
			 
			 
			 Let us try disabling the use of TLS 1.0 through the Registry Editor :
			 
			 
			 1. Look for HKEY_LOCAL_MACHINE
			2. Look for SYSTEM
			3. Look for CurrentControlSet
			4. Look for Control
			5. Look for SecurityProviders
			6. Look for SCHANNEL
			7. Look for Protocols. When we reach "Protocols", right-click on the Protocols folder, and select New -> Key
			8. Enter "TLS 1.0" in the newly-opened textbox
			9. Under "TLS 1.0", right-click on it, and Create a New Key called "Server"
			10. Under the new key "Server", right-click on it, and select New -> DWORD
			11. For the DWORD, enter "Enabled" in the textbox, and make sure that the value under data is 0, which effectively disables TLS 1.0


13. We check if the work we did was actually effective or not! 


			nmap -Pn -p 3389 --script ssl-enum-ciphers 192.168.208.136
			



14. Let us try **THC-Hydra** again!

			hydra -L login.txt -P password.txt -V (verbose) -t 1 (single task per thread rdp://192.168.208.136)

			 After replacing the actual working credentials on the username and password list files, an error can be observed indicating that due to the number of login attempts, the server locked us out! 






