



# Active Directory





Set up a Workstation, add users, disabled local adfministrator on both machines .






We will strengthen authentication 





We do not want to continue using NTLM V1. We can stop using NTLMV1 for traffic,m as it is easy to intercept 




You can trick people into authenticating into your server. 




## We must disable NTLMV1





## Group Policy Objects




#### Policy 



###### Local Policy 


For your machine 



###### Global Policy 


For the Domain 





**GLobal Policy** takes precedence over *Local Policies*






Organizational units are the *least* priority 





--------------------------------




windows + R 



DOne through the **GPMC**. If we arew making a new polict 


Cluick DOmain --<> group policy objects -- > Give it a name 



Naming scheme : DisableNTLMV1 ( or whatever you like )



Right click on the policy - edit




It will open a new window : 



Securutiy Options 



Find "Security LAN Manager Authentication "




Choose "NTLMV2 Response ONLY"






## Enable SMB Signing 




When logging in to a domain , you send your uisername and your NTLM hash to sign it. The domain would know that the authentication came from the partiucular computer. 



Enable SMB Signing ALWAYS!



Review the policies you want to enable.




## Limiting Cached Logins



When logging in to a Workstation, It keeps a hash called DCC2 , if the connection is lost between the machine and the Domain, then it is easier to deal with. 




As an attacker, cached hashes are useful for an attacker. The cache would be too big. You can make the cache 2. If youy disable the local admin, and you make the cache 2



We can edit "Security Stuff" , right-click , and when ready we can push it out. (90m-4 hours) 



If you run : 


	gpupdate /force 


It will force-apply the policy immediately. 




------------


## Windows Remote Management (**Win-RM**) :



	Powershell Remote Shell 


You can use tools to do *pass-the-hash*. It can be used in an attack, and if you want to update the policies for the workstation, and you can apply the policy without anyone knowing. You can make a script to apply a policy to all the Workstations in the domain. 



We have to run the *Win-RM Service*. 



We start the service, 



Aloow the firewall rule, 



You can uuse nmap 5585 to see if it is open. 



You should be able to enter **PFSession**, or aka... *interactive shell* 



Run *ipconfig* 



Invoke-Command -cimputername <workstyation_name> =ScriptBlock {ipconfig}



--------------------------------------



# File Shares 




Improper Access Control 

Improper handling of credentials 



File sharing is important for ActiveDirectory, as it iis how you interact with your team.




Consider when downloading an operating system from Azure, you would use it offline and locally





#### Full Control 



Full-control over the files. They can delete , edit , etc .. YOu should **NEVER** use *Full-Control*




#### Modify 



You can view the file , modify the files , R/W




#### Read/Execute



They can read and execute\e




#### Read



They can only read the file 



#### FTP is not Encrypted. Windows made SMB on 445. On the DC if we share the folder, on the workstation if we have permissions, we can map the folder to a particular location. On the workstation, we would see two shares: NETLOGON and SYSVOL






#### List Folder Contents : 


You can view the folders, but you can not see whats inside the file. You can see the file exists!





If we give permissions to a member who is part of both groups, and one group has more access, as far as file access goes, members should remain in one group only, and proper access control to be in place. 







## Creating a File Share 



Create a folder


Right click, and click properties



The folder inherits all the permissions of the C:\ Drive (if you create it there)



It is set to "Only-Administrator". That we do not want. We go to the advanced tab -- Sharfing 00 we can see all the different permissions. We will remove inherited permissions, and now we can start modifying it. 



We want to add a group/uyser, and he called them "Group 1" , and you place them there. We select whichever permissions we want. We go to the Sharing tab (advanced sharing), and give it a name "HRDepartment", add comments if you wish, and click OK. 




We should be able to login //IPAddress/Files. If we do not give write permissions, the user should not be able to modify it. 





After we finish Module 2 - Part 2 , we can proceed ot Part III





---------------------------



Some things are wromng with active directory  : 



use nmap for tportts 3389 , rdp-ntlm-info 

nmap -p 3389 --script rdp-ntlm-info


Cabn show Domain Information 


445 SMB smb-enum-shares




nmap -O   OS Information    , you can explot very ancient systemns 



53 DNS Dns Cache snoop dns-cache-snoop  use sudo , you can see what sites users atre going to , you go to Domain CControl visit nscc.ca , and then you can launch the script, and see that nscc.ca was visited 

--script-args 'dns-cache-snoop.domains={google.ca}



88 kerberos '





Best thing: Brute Force : RDP , SMB (AuxiliaryScanSMBBlock




Kerbrute   userenum  - brute (give it username, give it a password dictionary, you can brute force through kerbeross.)



username lists are important. LinkedIn is A good place, the organization's directory is also a good spot. If we know a student number, you can enumerate the numbers. 




Password lists :


ROCKYOU
KaNoSHI ( LONGER MORE RECENT)



Hint- Look for Default Passwords (Welcome, Spring2022, etc... ) 



If someone is forced to change their password every 3 months, their behaviour can be predictable, as tehy can change one letter, add one symbol, etc ... NIST recommends not changing the password too often 







Impacket : Good suite of tools for attacking ActiveDirectory. You can give it a password, NTLMV1 Hash, you can crack the hash or pass the hash. You can pass the hashes to anyone!


Impackt- Secretdump : This is how to can move from the workstation to another DC. Anytime you authenticate, the cached credentials should be in there. 


WMIexec : This overcomes many virus detections. It is a service you can use for running commands. it stays in memory! You need an administrator, workstation IP, and you get a shell , and you get to run commands with the privileges you have. 



PSExec : Detected by virus detectors easily. Creates a .exe puts it on a file share, and starts it as a service.  
		psexec.py ADMIN@DC_IP



SMBClient : Good for browsing file shares, SMB clients lists the shares. You ingerit privileges of whatever account. typoe shares to display all the file shares. 





### Tips for Active Directory Attacks :



Look for shares with a lot of access
Look for things that are stranged, such as weird ports. 
Look for misplaced programs, like a program stored in another place 
Look for Anonymous Access 






# Reports : 




Know the audience : Make a PowerPOint! 


The Lnaguagbe : For CFOs, they wont know what a VPN is. Use language appropriate to your target audience. Explain acronyms



Do not assume that you are writing for someone who is technically knowing 




Place your name, date , 


You can steal some pictures from teh company's page


Retrictions and Limitations : Legal. With penebrtrtation testing, tyou can explaining risk. You can not guarantee risk ( do not use strong or weak ). It is subjective. What is a strong password? for example. Use Objective language. 


We talke aboiut teh Scope and the Approach : If the site is breached, then we test it. 



Rules of Engagement : You stay within the rules or you go to prison, timeframe for testing, IPs to test , add a scoring guide so they have context. 
Based on the CVSS or SStandardized Vulnerabilty Scoring System used by most. There are others. first.org/cvss/

Nessus' scores are using a different scoring system. Bryan uses his own scoring system 



Execurityive Summary : IIntroduction to the assessment (context of what it was, and why), little table of vulnerabilties, a risk summary ( shows what the risk was, with diagrams showing how the attacker could exploit the vulnerabilties), damages (financial, reputational, )


They will ask "So what? " : Attacker can brute force your sytstem , attack your employees and your customers, mention the potential damages . 



Detailed Findings : for the IT team, it gets passed to them, for example scocial engineering 



When looking at SSL, Nessus score TLS1.0, in Wireshark there are millions of packets, and one could contain the credentials, you can do MITM for example. You can not copy Nessus. Next year, we will do a scan. 




Proof of Concept : A lot of people love to hide their methods. It is recommended to make custom scripts and mentioning what they could do. You can share your script with the client to make sure that the vulnerability has been remedied. You can pass the script to them securely or via email etc. 



If the table is going to be more than one page, do a list!



Do a technical Library : Explain Vulnerabiltiy., Always try to be as open as possible. 




Question: When giving a report, you are notifying them of the risk of compromise. SOmetimes, the client do provide you with a list of their preferred scope of operations, or aka ... **Crown Jewels**



If it is a 100-pages, it should take 10-hours. 


You have to be able to stick to the budget. People like automating, some things you can automate, such as explanations, but syou should not copy and paste from Nessus. You should clearly explain how it works, and how to remedy it. You want to help them as much as possible. Place them in the right direction. 





Understand the Audience, Do Weekly Reports on Incidents that happened, you have to be able to write a good report. Be open! Show your scripts! If you use publically - a vaialble exploits, share with them the name of the exploit and how it works (mention script kiddies). 



