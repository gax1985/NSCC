




# Active Directory





**Active Directory** is the reason why Windows is being used so much


This is what the school uses


We will be keeping it *local*



Computer Network that allows you to sign on any ciomputer with **Users** and **Groups**



> The Child will always ingerit from the Parent, but the Parent will not inheit from the child.

The child is always associated with the domain, but the trree is separate from the domain. 


## Forest


composed of multiple **trees** 

AI's input on this : 

		- A forest is the highest level of organization and includes one or more trees.
		- It's like an entire city that contains multiple neighborhoods (trees), and each neighborhood has its own houses (domains). The forest helps in managing resources and policies across the entire network.

## Tree

AI's input on this : 

		- A tree is a collection of domains that are grouped together in a hierarchical structure.
		- Think of it as several neighborhoods (domains) connected together. The tree structure helps in organizing and managing these domains efficiently.



## Domain


Group of users and computerst hat arew all connected together

AI's input on this : 


		- A domain is like a group or collection of computers, users, and other devices that share a common security database.
		- It's like a neighborhood where all the houses (computers and users) are part of the same community.

#### Sub-Domain


People in the Europle branch. DIfferent time zones, so they would have their won administrator


It should be no-trust. There is some trust between the sub-domains



Let us say you are starting a new sub-company. You would make a new **Tree** 


This is best case practice. This is how Microsoft desigmed it






Main part of the **Domain** is the **Domain Controller**


## Domain Controller

It is a Windows Sewrver

Authentication
Policies pushed out by Domain controller

DHCP
DNS
Printing


If we have control over it, we can modify DNS records, so we can re-direct traffic to a malicious site.

It does internal DHCP and intercal DNS


>[!warning]
> DO NOT MAKE IT FACING THE WORLD!
> HAVE IT COMPLETELY SEPARATE FROM THE OUTSIDE



## User


Someone using the computer


they should have their account locked down 


is a part of a **Group**



By default , it is the Principe of Least Privalge : 


Normal users should not be able to install software, changing configurations and regustru keys, should be able to have their OWN information only!\



## Administrator Account



Administrator who controls everything. 

Called **Domain Administrator**


They can install software, configure machines etc... 

Types : 


Install/Network Admin, DOmain Admins, Enterprise Admins




## Enterprise Admin


Has power over every tree, every forest, and every domain. 




## Groups


### Groups of Users



Assign priviledges to groups


### Groups of COmputers







## Organizational Unit



You can hold users, groups and computers

Can assign security policy to an Otganizational Unit, 
'


Main difference : organization and control of objest over group policies




## Volumes



Remote file shares. ANYTHING THAT CAN BE ACCESSED



Hopefully it is a separate file share server. Much like Onedrive but local. 


You would have a folder for Finance , etc. ...



It will map drives to different computers. 



We will see how policies are pushed out. There is something called *Netlogger*



The policies arrive via SMB from the drives. 



We have multiple organizational units. 


Pretent there is a pc in the podium, next to it file server, and clients all around the rooom. 


We have groups file shares, computers, and then 8that connects to the internet and people can connect with the vpn,. They may be an otrganizational unit for the VPN. They would have access to the domain similarly to being present in the room . 





# Authentication 


Biggest attack surface in the Windows DOmain


It is about grabbing credentials , and navigating 


There is : 


## NTLM 

#### Version 1 


Still acctive, windows 2008 server and for older devices. This is a way to store the password. Windows Controller does it by *Hashing* . NTLM is the **Hashing ALgoprithm**

You are not supposed to decrypt it. When logging in, the hashes are compared. 


#### Hashes : 

i 
#### Challenge-Response Protocol 


CLient says " Hi I am the user. I would like access"
PC : "I will end you a challenge of a random collections of strings and characters"./. it encrypts the hash with the NTLM hash. It will ask the client to do the same
Client encrypts the hashed password with the password as a key. If you can get someone's hash, you do not need the passworld. AKA **Pass-the-Hash**. 


Programs like *hashcat* can bnreak the hash.


NTLM2 is timed, NTLM is not





NTLM breaks the password into 7-charactrer chunks, wit pad with 0 
Usaed 56-DES-cipher to encrypt the chiunks and joins then all together. It can pass the hash!


Registry Hyde is a registry of keys. SAMS are holding the keys as well. You need the system key to decrypt it.


LSAS is where the keys is stored in memory. 


SAM is the local accoutn for the registry, and sercurity is tyeh domain account.




# NTLM V2


It is newer. It is in use now. It has a time =-challenge as well. You would not be able to pass the hash. 

# Kerberos

Based on a "ticking system". Designed in MIT


We have clients, a file server, and the DC is the ticket issuing server. 
If we want to request access to a file, the server will talk to teh ticket server and ask for a ticket and then it will compatre it generates elsewhere. You would uyse the hash to encrypt the ticket, and the ticket is good for an amount of time, It is fggood for ONE CLIENT. The ticket can only be used at that time. 


KerboRoasting : it is an attack involving a ticket from an infected lcient to a servcie account which uses NTLM hash to encrypt the ticket, and you try to get the hash from it. 


If we wre to request a ticket as a spoofed client, you would need access to the domain and the machine. If we have a user account on a client, depending on privileges, you can make a request from the account. MySQL may not be abailable to the user, but it is available for the service account. 




## LM 


It was from the 1990s

Simplest algorithm that you have 



# common vulnerabitiles with acvess directory : 




Over privilages users / groups
Using old NTLM`
Using SMB Relay, which involves a broadcast message. The file server will broadcast llmer , when you look at the file share, it would be identified. The malicious actor broadactas the message the file share will do, and get everyone to come to tgeir server 
SMB signing is off by default > turn it on! it will sign the challenge with its private key. If you try to relay it around,. it would not accept it. THis is how you stop an SMB relay attack. 
Caching many logons : passwords are encrypted with DCC/1. If you use a client pc, the DC will be using a cached password.  use 1-3 cached

No Lockout policy, which enables brute force attacks
Abuse of local administator : use of one local administartor. there should be different passwords for different computers. You can designate a computer to hold the secrets and add different passwords for access. Local Administator should be Disabled!





Slides 23-46 , we will set up a **Domain**. Windows does not like it if you have more than 15 characters for the Domain. By default, domain will be .local , which makes it easier for attackers. Keep it short. 

When logging in to a windows machine , the server manager will pop up. 

